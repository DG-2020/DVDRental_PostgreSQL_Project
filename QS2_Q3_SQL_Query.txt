WITH T_YR AS
	(SELECT DATE_TRUNC('year', P.PAYMENT_DATE) AS PAY_YEAR,
			CU.FIRST_NAME || ' ' || CU.LAST_NAME AS FULL_NAME, SUM(P.AMOUNT) AS TOTAL_AMT
		FROM CUSTOMER AS CU
		JOIN PAYMENT AS P ON P.CUSTOMER_ID = CU.CUSTOMER_ID
		GROUP BY 1, 2
		ORDER BY 3 DESC
		LIMIT 10),
	T_MTH AS
	(SELECT DATE_TRUNC('month', P.PAYMENT_DATE) AS PAY_MTH,
			CU.FIRST_NAME || ' ' || CU.LAST_NAME AS FULL_NAME_2, SUM(P.AMOUNT) AS PAY_AMT, COUNT(P.AMOUNT) AS COUNT_PER_MTH 
		FROM CUSTOMER AS CU
		JOIN PAYMENT AS P ON P.CUSTOMER_ID = CU.CUSTOMER_ID
		GROUP BY 2, 1)
SELECT PAY_MTH, FULL_NAME_2, PAY_AMT,
	LEAD(PAY_AMT) OVER (PARTITION BY FULL_NAME_2 ORDER BY PAY_MTH) AS LEAD,
	LEAD(PAY_AMT) OVER (PARTITION BY FULL_NAME_2 ORDER BY PAY_MTH) - PAY_AMT AS LEAD_DIFF
FROM T_YR
JOIN T_MTH ON T_YR.FULL_NAME = T_MTH.FULL_NAME_2
ORDER BY 2,1;